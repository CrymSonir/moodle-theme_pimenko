{"version":3,"file":"catalog.min.js","sources":["../src/catalog.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * @copyright  Pimenko 2019\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine(['jquery', 'core/ajax', 'core/templates', 'core/config'], function($, ajax, templates, cfg) {\n    let categorySelect = $('#page-course-index-category .categoryselect .urlselect .custom-select');\n    let tagSelect = $('#page-course-index-category .tagselect .urlselect .custom-select');\n    let customfieldSearch = $('#page-course-index-category .customfieldsearch form');\n    let customfieldDate = $('#page-course-index-category .customfielddate form select');\n    let categorySearch = $('#page-course-index-category .searchcourse form.simplesearchform input');\n    let resetbutton = $('#page-course-index-category button.btn[data-filteraction=\\'reset\\']');\n\n    let startQuery = function() {\n        categorySelect.attr(\"disabled\", \"true\");\n        tagSelect.attr(\"disabled\", \"true\");\n        categorySearch.attr(\"disabled\", \"true\");\n        $('#course-gallery').attr(\"style\", \"opacity: 0.25;\");\n        $('#loader-gallery').attr(\"style\", \"display: flex;\");\n    };\n\n    let endQuery = function(nbCourses) {\n        categorySelect.removeAttr(\"disabled\");\n        tagSelect.removeAttr(\"disabled\");\n        categorySearch.removeAttr(\"disabled\");\n        $('#course-gallery').attr(\"style\", \"opacity: 1;\");\n        $('#loader-gallery').attr(\"style\", \"display: none;\");\n        let buttonLoadMore = $('#load-more');\n        if (nbCourses > 12) {\n            buttonLoadMore.show();\n        }\n\n        buttonLoadMore.click(function() {\n            let courses = document.getElementsByClassName('course-gallery');\n            let nbCourseMore = 1;\n            for (let i in courses) {\n                if (courses.item(parseInt(i)).style.display === 'none') {\n                    if (nbCourseMore <= 6) {\n                        courses.item(parseInt(i)).style.display = 'flex';\n                        if (parseInt(i) === courses.length - 1) {\n                            $('#load-more').hide();\n                        }\n                        nbCourseMore++;\n                    } else {\n                        break;\n                    }\n                }\n            }\n        });\n    };\n\n    let doQuery = function(response) {\n        if (typeof (response) != 'undefined') {\n            let courses = response.courses;\n            let toDestroy;\n            let nbCourse = 1;\n            let template = {};\n            for (let i in courses) {\n                // Url of picture.\n                if (courses[i].overviewfiles[0] && courses[i].overviewfiles[0].fileurl) {\n                    courses[i].urlimg = courses[i].overviewfiles[0].fileurl.replace(\"webservice\\/\", \"\");\n                }\n\n                courses[i].name = courses[i].fullname;\n                courses[i].category = courses[i].categoryname;\n                courses[i].rootpath = cfg.wwwroot;\n                if (courses[i].enrollmentmethods.includes(\"synopsispaypal\")) {\n                    courses[i].url = cfg.wwwroot + '/enrol/synopsispaypal/index.php?id=' + courses[i].id;\n                } else if (courses[i].enrollmentmethods.includes(\"synopsis\")) {\n                    courses[i].url = cfg.wwwroot + '/enrol/synopsis/index.php?id=' + courses[i].id;\n                } else {\n                    courses[i].url = cfg.wwwroot + '/course/view.php?id=' + courses[i].id;\n                }\n\n                if (nbCourse <= 12) {\n                    courses[i].display = \"flex\";\n                } else {\n                    courses[i].display = \"none\";\n                }\n                nbCourse++;\n\n                // Course 1 to remove.\n                if (courses[i].id === 1) {\n                    toDestroy = i;\n                }\n            }\n            // Remove the course 1 of moodle.\n            if (toDestroy) {\n                courses.splice(toDestroy, 1);\n            }\n            if (courses.length > 12) {\n                template.loadmore = true;\n            }\n\n            template.courses = courses;\n\n            // Rendering of results.\n            templates.render('theme_pimenko/course_gallery', template, 'theme_pimenko').then(function(html) {\n                let element = document.getElementById('course-gallery');\n                let parent = element.parentElement;\n                parent.removeChild(element);\n                parent.insertAdjacentHTML('beforebegin', html);\n                endQuery(courses.length);\n            }).fail(function(ex) {\n                /* eslint no-console: \"off\" */\n                console.error(ex);\n                endQuery();\n            });\n        }\n    };\n\n    let eventcatalog = function() {\n        categorySelect.change(function() {\n            let href = categorySelect.val();\n            categorySearch.val(\"\");\n\n            if (href !== \"all\") {\n                document.location.href = href;\n            } else {\n                document.location.href = \"/course/index.php\";\n            }\n        });\n\n        customfieldSearch.submit(function(event) {\n            event.preventDefault();\n            event.stopPropagation();\n\n            let href = this.action;\n            let value = this.querySelector('input').value;\n            console.log(value);\n\n            if (value === \"\") {\n                href = href + '&customfieldvalue=all';\n                document.location.href = href;\n            } else {\n                href = href + '&customfieldvalue=' + value;\n                document.location.href = href;\n            }\n        });\n\n        customfieldDate.change(function() {\n\n            let parent = this.form;\n            let datevalues = new FormData(parent);\n            let href = parent.action;\n\n            let datatype = parent.closest('.customfielddate').dataset.name;\n\n            href = href + '?customfieldselected=' + datatype + '&day=' +\n                datevalues.get('date_selector[day]') +\n                '&month=' + datevalues.get('date_selector[month]') +\n                '&year=' + datevalues.get('date_selector[year]');\n            document.location.href = href;\n        });\n\n        resetbutton.click(function() {\n            document.location.href = \"/course/index.php\";\n        });\n\n        $('#page-course-index-category .searchcourse form.simplesearchform').submit(function(event) {\n            event.preventDefault();\n            event.stopPropagation();\n\n            if (categorySearch.val() === '') {\n                document.location.href = \"/course/index.php\";\n            }\n\n            let searchargs = {\n                criterianame: 'search',\n                criteriavalue: categorySearch.val(),\n                page: 0,\n                perpage: 100\n            };\n\n            let promises = ajax.call([\n                {methodname: 'theme_pimenko_search_courses', args: searchargs}\n            ]);\n\n            startQuery();\n\n            promises[0].done(function(response) {\n                categorySelect.val(\"all\");\n                tagSelect.val('/course/index.php?tagid=0');\n                doQuery(response);\n            }).fail(function(ex) {\n                /* eslint no-console: \"off\" */\n                console.log(ex);\n                console.error('search_courses : ' + ex.exception.message);\n            });\n        });\n\n        $('#load-more').click(function() {\n            let courses = document.getElementsByClassName('course-gallery');\n            let nbCourseMore = 1;\n            for (let i in courses) {\n                if (courses.item(parseInt(i)).style.display === 'none') {\n                    if (nbCourseMore <= 12) {\n                        courses.item(parseInt(i)).style.display = 'flex';\n                        if (parseInt(i) === courses.length - 1) {\n                            $('#load-more').hide();\n                        }\n                        nbCourseMore++;\n                    } else {\n                        break;\n                    }\n                }\n            }\n        });\n    };\n\n    return {\n        init: function() {\n            eventcatalog();\n        }\n    };\n});\n"],"names":["define","$","ajax","templates","cfg","categorySelect","tagSelect","customfieldSearch","customfieldDate","categorySearch","resetbutton","endQuery","nbCourses","removeAttr","attr","buttonLoadMore","show","click","courses","document","getElementsByClassName","nbCourseMore","i","item","parseInt","style","display","length","hide","eventcatalog","change","href","val","location","submit","event","preventDefault","stopPropagation","this","action","value","querySelector","console","log","parent","form","datevalues","FormData","closest","dataset","name","get","searchargs","criterianame","criteriavalue","page","perpage","promises","call","methodname","args","done","response","toDestroy","nbCourse","template","overviewfiles","fileurl","urlimg","replace","fullname","category","categoryname","rootpath","wwwroot","enrollmentmethods","includes","url","id","splice","loadmore","render","then","html","element","getElementById","parentElement","removeChild","insertAdjacentHTML","fail","ex","error","doQuery","exception","message","init"],"mappings":"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"}